

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Model and Persistent Stores &mdash; Tethys Platform 0.1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Tethys Platform 0.1.0 documentation" href="../index.html"/>
        <link rel="up" title="Getting Started" href="../getting_started.html"/>
        <link rel="next" title="The View and Templating" href="view.html"/>
        <link rel="prev" title="Generate New App with Scaffold" href="scaffold.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> Tethys Platform</a>
        
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../features.html">Tethys Platform</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../features.html#develop-web-apps">Develop Web Apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#python-software-development-kit">Python Software Development Kit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#templating-and-gizmos">Templating and Gizmos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#spatial-data">Spatial Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#data-store">Data Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#computing">Computing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#developer-tools">Developer Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../features.html#production-ready">Production Ready</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#install-the-dependencies">1. Install the Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#install-advanced-dependencies">2. Install Advanced Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-virtual-environment-and-install-tethys-platform">3. Create Virtual Environment and Install Tethys Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-database-and-database-users">4. Create Database and Database Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-settings-file-and-configure-settings">5. Create Settings File and Configure Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#create-database-tables">6. Create Database Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#start-up-the-django-development-server">7. Start up the Django Development Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#what-s-next">What&#8217;s Next?</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../getting_started.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="scaffold.html">Generate New App with Scaffold</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">The Model and Persistent Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="view.html">The View and Templating</a></li>
<li class="toctree-l2"><a class="reference internal" href="controller.html">Working with the Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="url_mapping.html">URL Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="forms.html">Working with Form Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Configuring Apps</a></li>
<li class="toctree-l2"><a class="reference internal" href="distribution.html">Distributing Apps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tethys_api.html">Tethys Software Development Kit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tethys_api/dataset_services.html">Dataset Services API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_api/spatial_database.html">Persistent Stores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_api/spatial_publishing.html">Spatial Data Publishing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_api/geoprocessing.html">Geoprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_api/visualizing.html">Data Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tethys_api/cloud_computing.html">High Performance Computing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Summary of References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Tethys Platform</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../getting_started.html">Getting Started</a> &raquo;</li>
      
    <li>The Model and Persistent Stores</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/getting_started/persistent_stores.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="the-model-and-persistent-stores">
<h1>The Model and Persistent Stores<a class="headerlink" href="#the-model-and-persistent-stores" title="Permalink to this headline">¶</a></h1>
<p><strong>Last Updated:</strong> June 4, 2014</p>
<p>In the last step, you generated a new Tethys App using the scaffold template. In this part of the tutorial we&#8217;ll explore the Model aspect of MVC. We&#8217;ll show you how to use SQLAlchemy to create a simple database model, initialize the database, and run simple queries.</p>
<p>The Model component of MVC represents the data management of your app. Data for your app can be stored in Python data structures (e.g.: lists, dictionaries, and NumPy arrays), databases, CKAN datasets, or in files (e.g. plain text or csv). There are many Python libraries available for interacting with databases and the built in Python IO modules can be used to work with files.</p>
<p>In this tutorial we will work with an SQL database object relational mapper (ORM) called <a class="reference external" href="http://www.sqlalchemy.org/">SQLAlchemy</a>. SQLAlchemy allows developers to interface with SQL databases using an object oriented approach. It can interface with nearly any SQL database. To learn more about SQLAlchemy, we recommend <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/orm/tutorial.html">this</a> tutorial to get a good overview.</p>
<p>As of version 0.3 of the Tethys Apps plugin, developers are now able to request <a class="reference internal" href="../glossary.html#term-persistent-stores"><em class="xref std std-term">persistent stores</em></a> (databases) that are automatically created and initialized during the app installation process.In this tutorial, you&#8217;ll use one of these persistent stores as the database for your app.</p>
<p>If your app was generated using the app scaffold prior to version 0.3 of the Tethys Apps plugin, you may need to add a few lines of code to your <a class="reference internal" href="../glossary.html#term-app-configuration-file"><em class="xref std std-term">app configuration file</em></a> (<tt class="file docutils literal"><span class="pre">app.py</span></tt>). and your <a class="reference internal" href="../glossary.html#term-setup-script"><em class="xref std std-term">setup script</em></a> (<tt class="file docutils literal"><span class="pre">setup.py</span></tt>) to enable the automatic <a class="reference internal" href="../glossary.html#term-persistent-store"><em class="xref std std-term">persistent store</em></a> provisioning feature. See <a class="reference internal" href="#enable-persistent-store-legacy-apps"><em>Enabling Persistent Store for Legacy Apps</em></a> on how to do this. The following tutorial will walk you through the steps of creating a new persistent store, creating an SQLAlchemy data model, and intializing the persistent store.</p>
<div class="section" id="register-a-persistent-store">
<h2>Register a Persistent Store<a class="headerlink" href="#register-a-persistent-store" title="Permalink to this headline">¶</a></h2>
<p>The first step in working with persistent stores is to register a new persistent store. This is done in the <a class="reference internal" href="../glossary.html#term-app-configuration-file"><em class="xref std std-term">app configuration file</em></a>. Open the <a class="reference internal" href="../glossary.html#term-app-configuration-file"><em class="xref std std-term">app configuration file</em></a> for your app (<tt class="file docutils literal"><span class="pre">~/tethysdev/ckanapp-my_first_app/ckanapp/my_first_app/app.py</span></tt>). To register a new persistent store we need to add an entry to the <tt class="docutils literal"><span class="pre">registerPersistentStores()</span></tt> method of your <a class="reference internal" href="../glossary.html#term-app-class"><em class="xref std std-term">app class</em></a>. Lets create a persistent store for storing information about stream gages. Modify the <tt class="docutils literal"><span class="pre">registerPersistentStores()</span></tt> method so it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">registerPersistentStores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">persistentStores</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add one or more persistent stores</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">persistentStores</span><span class="o">.</span><span class="n">addPersistentStore</span><span class="p">(</span><span class="s">&#39;stream_gage_db&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">addPersistentStore()</span></tt> method accepts the name of the persistent store as the only argument. In this case we will call our persistent store &#8220;stream_gage_db&#8221;.</p>
</div>
<div class="section" id="create-sqlalchemy-model">
<h2>Create SQLAlchemy Model<a class="headerlink" href="#create-sqlalchemy-model" title="Permalink to this headline">¶</a></h2>
<p>After we have registered our persistent store, we need to create a data model for the tables that will be store our data. For this tutorial we will do this using SQLAlchemy.</p>
<ol class="arabic simple">
<li>Create a new file called <tt class="file docutils literal"><span class="pre">stream_gage_model.py</span></tt> located in your <a class="reference internal" href="../glossary.html#term-app-package"><em class="xref std std-term">app package</em></a> (<tt class="file docutils literal"><span class="pre">~/tethysdev/ckanapp-my_first_app/ckanapp/my_first_app</span></tt>).</li>
<li>Copy and paste the following contents into the file:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="kn">from</span> <span class="nn">ckanapp.my_first_app.lib</span> <span class="kn">import</span> <span class="n">get_persistent_store_engine</span>
</pre></div>
</div>
<p>These lines import all of the necessary modules from SQLAlchemy that the stream gages data model will need. There is also a method imported from your app&#8217;s library (<tt class="docutils literal"><span class="pre">ckanapp.my_first_app.lib</span></tt>) called <tt class="docutils literal"><span class="pre">get_persistent_store_engine()</span></tt>. This method is used to retrieve a connection to the persisent store and it is generated by the app scaffold.</p>
<ol class="arabic simple" start="3">
<li>Next add these lines to <tt class="file docutils literal"><span class="pre">stream_gages_model.py</span></tt>:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># DB Engine, sessionmaker and base</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">get_persistent_store_engine</span><span class="p">(</span><span class="s">&#39;stream_gage_db&#39;</span><span class="p">)</span>
<span class="n">SessionMaker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
</pre></div>
</div>
<p>These lines are very important. You will use some of the elements defined here whenever you need to interact with your persistent store. First, the <tt class="docutils literal"><span class="pre">get_persistent_store_engine()</span></tt> method is used to retrieve an SQLAlchemy <tt class="docutils literal"><span class="pre">engine</span></tt> object. This object contains the information needed to connect to the persistent store. The <tt class="docutils literal"><span class="pre">get_persistent_store_engine()</span></tt> method accepts the name of a persistent store as an argument and returns the engine with connection information for that store.</p>
<p>Next, we create an SQLAlchemy session maker, <tt class="docutils literal"><span class="pre">SessionMaker</span></tt> and bind it to the engine. Anytime you want to query or modify your persistent store data, you will do so with an SQLAlchemy <tt class="docutils literal"><span class="pre">session</span></tt> object. You obtain a <tt class="docutils literal"><span class="pre">session</span></tt> object by importing the session maker and intantiating it. Finally, we create an instance of an SQLAlchemy <tt class="docutils literal"><span class="pre">declarative_base</span></tt> and call it <tt class="docutils literal"><span class="pre">Base</span></tt>. The declarative base is also very important, but it will be discussed in more detail later on.</p>
<ol class="arabic simple" start="4">
<li>Finally, add these lines to <tt class="file docutils literal"><span class="pre">stream_gages_model.py</span></tt>:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">StreamGage</span> <span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Example SQLAlchemy DB</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;stream_gages&#39;</span>

    <span class="c"># Columns</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for a gage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="n">latitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="n">longitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_gages_as_geojson</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a GeoJSON object representing all gages in db</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Create a session</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">SessionMaker</span><span class="p">()</span>

        <span class="c"># Query DB for gage objects</span>
        <span class="n">gages</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c"># Create geojson object</span>
        <span class="n">geojson_gages</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;GeometryCollection&quot;</span><span class="p">,</span>
                         <span class="s">&quot;geometries&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">geometries</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Create geometry objects for each gage</span>
        <span class="k">for</span> <span class="n">gage</span> <span class="ow">in</span> <span class="n">gages</span><span class="p">:</span>
            <span class="n">gage_geometry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;Point&quot;</span><span class="p">,</span>
                                                     <span class="n">coordinates</span><span class="o">=</span><span class="p">[</span><span class="n">gage</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">gage</span><span class="o">.</span><span class="n">longitude</span><span class="p">],</span>
                                 <span class="n">properties</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">gage</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>
            <span class="n">geometries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gage_geometry</span><span class="p">)</span>

        <span class="n">geojson_gages</span><span class="p">[</span><span class="s">&#39;geometries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geometries</span>
        <span class="k">return</span> <span class="n">geojson_gages</span>
</pre></div>
</div>
<p>This class, <tt class="docutils literal"><span class="pre">StreamGage</span></tt> contains the definition for a table called &#8220;stream_gages&#8221;. Notice that the class inherits from the <tt class="docutils literal"><span class="pre">Base</span></tt> class that we created in the previous lines. The class also has a private property, <tt class="docutils literal"><span class="pre">__tablename__</span></tt> that defines the name of the table that will be created in the database. The class also has four other properties that are SQLAlchemy <tt class="docutils literal"><span class="pre">Column</span></tt> objects: <em>id</em>, <em>latitude</em>, <em>longitude</em>, and <em>value</em>. These properties define the columns of the &#8220;stream_gages&#8221; table. The column type and options are defined by the arguments passed to the <tt class="docutils literal"><span class="pre">Column</span></tt> constructor. For example, the <em>latitude</em> column is of type <tt class="docutils literal"><span class="pre">Float</span></tt> while the <em>id</em> column is of type <tt class="docutils literal"><span class="pre">Integer</span></tt> and also flagged as the primary key for the table. The <tt class="docutils literal"><span class="pre">StreamGage</span></tt> class also has a simple constructor method called <tt class="docutils literal"><span class="pre">__init__()</span></tt> and a class method called <tt class="docutils literal"><span class="pre">get_gages_as_geojson()</span></tt>.</p>
<p>This class is not only used to define the tables for your persistent store, it will also be used to create objects for interacting with your data. Each instance of the <tt class="docutils literal"><span class="pre">StreamGage</span></tt> class will reperesent one row or record in the &#8220;stream_gages&#8221; table and the properties of the instance will have as values the values of the columns in that record. We&#8217;ll illustrate how to use these objects for interacting the database in  the next section.</p>
</div>
<div class="section" id="create-an-initialization-script">
<h2>Create an Initialization Script<a class="headerlink" href="#create-an-initialization-script" title="Permalink to this headline">¶</a></h2>
<p>Now that you have created a data model, the next step is to write a database initialization script. This script will use your database model and SQLAlchemy to create all the tables. We&#8217;ll also use this script to add some dummy data for testing.</p>
<ol class="arabic simple">
<li>Create a new file called     <tt class="file docutils literal"><span class="pre">init_stream_gages_db.py</span></tt> in your <a class="reference internal" href="../glossary.html#term-app-package"><em class="xref std std-term">app package</em></a> <tt class="file docutils literal"><span class="pre">lib</span></tt> directory (<tt class="file docutils literal"><span class="pre">~/tethysdev/ckanapp-my_first_app/ckanapp/my_first_app/lib</span></tt>).</li>
<li>Add the following lines to your     <tt class="file docutils literal"><span class="pre">init_stream_gages_db.py</span></tt> script:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckanapp.my_first_app.stream_gage_model</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">StreamGage</span><span class="p">,</span> <span class="n">SessionMaker</span>

<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
<p>Believe it or not, these two lines are all that is needed to create all of the tables in your persistent store. The <tt class="docutils literal"><span class="pre">Base</span></tt> object that our model class inherits from contains a <tt class="docutils literal"><span class="pre">metadata</span></tt> object. The <tt class="docutils literal"><span class="pre">metadata</span></tt> object collects all of the information about the tables in our data model from the classes that inherit <tt class="docutils literal"><span class="pre">Base</span></tt>. We call the <tt class="docutils literal"><span class="pre">metadata.create_all()</span></tt> to create the tables and we give it the <tt class="docutils literal"><span class="pre">engine</span></tt> object from our <tt class="file docutils literal"><span class="pre">stream_gages_model.py</span></tt> file to point it at the right database. After the tables are created, let&#8217;s have the initialization script load some dummy data into our database so we can make sure everything is working properly.</p>
<ol class="arabic simple" start="3">
<li>First, we need to create a <tt class="docutils literal"><span class="pre">session</span></tt> object to interact with the database. We will use the <tt class="docutils literal"><span class="pre">SessionMaker</span></tt> object that we created in our <tt class="file docutils literal"><span class="pre">stream_gages_model.py</span></tt> to create a new <tt class="docutils literal"><span class="pre">session</span></tt>. Add these lines to your <tt class="file docutils literal"><span class="pre">init_stream_gages_db.py</span></tt> script:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create a Session</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">SessionMaker</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Next, we need to add some dummy data. To do so, we create several instances of the <tt class="docutils literal"><span class="pre">StreamGage</span></tt> class. Each instance will represent a new row in our &#8220;stream_gages&#8221; table. Copy and paste the following line of code into your <tt class="file docutils literal"><span class="pre">init_stream_gages_db.py</span></tt> script:</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Gage 1</span>
<span class="n">gage1</span> <span class="o">=</span> <span class="n">StreamGage</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="mf">40.23812952992122</span><span class="p">,</span>
                   <span class="n">longitude</span><span class="o">=-</span><span class="mf">111.69585227966309</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gage1</span><span class="p">)</span>

<span class="c"># Gage 2</span>
<span class="n">gage2</span> <span class="o">=</span> <span class="n">StreamGage</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="mf">40.238784729316215</span><span class="p">,</span>
                   <span class="n">longitude</span><span class="o">=-</span><span class="mf">111.7101001739502</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gage2</span><span class="p">)</span>

<span class="c"># Gage 3</span>
<span class="n">gage3</span> <span class="o">=</span> <span class="n">StreamGage</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="mf">40.23650788415366</span><span class="p">,</span>
                   <span class="n">longitude</span><span class="o">=-</span><span class="mf">111.73278093338013</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gage3</span><span class="p">)</span>

<span class="c"># Gage 4</span>
<span class="n">gage4</span> <span class="o">=</span> <span class="n">StreamGage</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="mf">40.242519244799816</span><span class="p">,</span>
                   <span class="n">longitude</span><span class="o">=-</span><span class="mf">111.68254852294922</span><span class="p">,</span>
                   <span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gage4</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>Notice that everytime we create a new <tt class="docutils literal"><span class="pre">StreamGage</span></tt> object, we add it to the <tt class="docutils literal"><span class="pre">session</span></tt> object using the <tt class="docutils literal"><span class="pre">session.add()</span></tt> method. Finally, when we are ready to persist the data, we call the <tt class="docutils literal"><span class="pre">session.commit()</span></tt> method. Querying using SQLAlchemy will be covered in the <a class="reference internal" href="controller.html"><em>Working with the Controller</em></a> tutorial.</p>
</div>
<div class="section" id="register-initialization-script">
<h2>Register Initialization Script<a class="headerlink" href="#register-initialization-script" title="Permalink to this headline">¶</a></h2>
<p>Now that you have created a database initialization script, we can register it to be run automatically when the app is installed. To do so, modify the <tt class="docutils literal"><span class="pre">registerPersistentStores()</span></tt> method in your <a class="reference internal" href="../glossary.html#term-app-configuration-file"><em class="xref std std-term">app configuration file</em></a> so it looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">registerPersistentStores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">persistentStores</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add one or more persistent stores</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">persistentStores</span><span class="o">.</span><span class="n">addPersistentStore</span><span class="p">(</span><span class="s">&#39;stream_gage_db&#39;</span><span class="p">)</span>
    <span class="n">persistentStores</span><span class="o">.</span><span class="n">addInitializationScript</span><span class="p">(</span><span class="s">&#39;my_first_app.lib.init_stream_gages_db&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="reinstall-app">
<h2>Reinstall App<a class="headerlink" href="#reinstall-app" title="Permalink to this headline">¶</a></h2>
<p>Everytime you add a new persistent store to your app, you will need to reinstall the app to have it created. Everytime you make changes to your data model (i.e.: edit the tables and columns), you will need to reinstall the app or rerun your database initialization script. The app can be reinstalled like so:</p>
<div class="highlight-python"><div class="highlight"><pre>$ . /usr/lib/ckan/default/bin/activate
$ cd ~/tethydev/ckanapp-my_first_app
$ python setup.py develop
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want to hard install your app (which is not recommended under development) use the <strong class="command">install</strong> command instead of <strong class="command">develop</strong>. See <a class="reference internal" href="../working_with_apps.html"><em>Working with Apps</em></a>.</p>
</div>
</div>
<div class="section" id="data-model-under-development">
<h2>Data Model Under Development<a class="headerlink" href="#data-model-under-development" title="Permalink to this headline">¶</a></h2>
<p>While you are developing your database model, you will likely make changes to the tables and columns frequently. To create updated tables and columns, you will first need to drop the old tables. Add the following line to your database initialization script just before the line that calls <tt class="docutils literal"><span class="pre">Base.metadata.create_all()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</pre></div>
</div>
<p>This will have the effect of dropping all the tables and then creating them again everytime you run the initialization script. <strong>Don&#8217;t forget to take this line out when your distribute your app</strong>. Leaving it in could have confusing consequences and lead to loss of data.</p>
</div>
<div class="section" id="enabling-persistent-store-for-legacy-apps">
<span id="enable-persistent-store-legacy-apps"></span><h2>Enabling Persistent Store for Legacy Apps<a class="headerlink" href="#enabling-persistent-store-for-legacy-apps" title="Permalink to this headline">¶</a></h2>
<p>If you are working with an app that was generated with the scaffold prior to version 0.3 of the Tethys Apps plugin, you will need to follow these steps to enable automatic persistent stores:</p>
<div class="section" id="modify-the-setup-script">
<h3>Modify the Setup Script<a class="headerlink" href="#modify-the-setup-script" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Add the following import statements to the <strong>top</strong> of your app&#8217;s <a class="reference internal" href="../glossary.html#term-setup-script"><em class="xref std std-term">setup script</em></a> (<tt class="file docutils literal"><span class="pre">setup.py</span></tt>):</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">ckanext.tethys_apps.lib.persistent_store</span> <span class="kn">import</span> <span class="n">provision_persistent_stores</span>
<span class="kn">from</span> <span class="nn">ckanext.tethys_apps.lib</span> <span class="kn">import</span> <span class="n">get_ckanapp_directory</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Add these lines to the <strong>bottom</strong> of your app&#8217;s <a class="reference internal" href="../glossary.html#term-setup-script"><em class="xref std std-term">setup script</em></a> (<tt class="file docutils literal"><span class="pre">setup.py</span></tt>):</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre># Provision tethys databases for app
provision_persistent_stores(&lt;your.app.class&gt;)
</pre></div>
</div>
<p>Replace &lt;your.app.class&gt; with the path to your app class using dot notation. For example, for the <tt class="docutils literal"><span class="pre">my_first_app</span></tt> example, the path to the app class would be:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;my_first_app.app:MyFirstAppApp&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-the-app-configuration-file">
<h3>Modify the App Configuration File<a class="headerlink" href="#modify-the-app-configuration-file" title="Permalink to this headline">¶</a></h3>
<p>Add the <tt class="docutils literal"><span class="pre">registerPersistentStores()</span></tt> method to the bottom of your <a class="reference internal" href="../glossary.html#term-app-class"><em class="xref std std-term">app class</em></a> in the <a class="reference internal" href="../glossary.html#term-app-configuration-file"><em class="xref std std-term">app configuration file</em></a> (<tt class="file docutils literal"><span class="pre">app.py</span></tt>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">registerPersistentStores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">persistentStores</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add one or more persistent stores</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># persistentStores.addPersistentStore(&#39;example_db&#39;)</span>
    <span class="c"># persistentStores.addInitializationScript(&#39;example.lib.init_db&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="add-method-to-app-lib">
<h3>Add Method to App Lib<a class="headerlink" href="#add-method-to-app-lib" title="Permalink to this headline">¶</a></h3>
<p>Finally, add this method to your <tt class="docutils literal"><span class="pre">lib.__init__.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ckanext.tethys_apps.lib.persistent_store</span> <span class="kn">import</span> <span class="n">get_persistent_store_engine</span> <span class="k">as</span> <span class="n">gpse</span>

<span class="k">def</span> <span class="nf">get_persistent_store_engine</span><span class="p">(</span><span class="n">persistent_store_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wrapper for the get_persistent_store_engine method that makes it easier to use</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Derive app name</span>
    <span class="n">app_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Get engine</span>
    <span class="k">return</span> <span class="n">gpse</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">persistent_store_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="install-the-latest-version-of-tethys-apps-plugin">
<h3>Install the Latest Version of Tethys Apps Plugin<a class="headerlink" href="#install-the-latest-version-of-tethys-apps-plugin" title="Permalink to this headline">¶</a></h3>
<p>Follow the instructions at <a class="reference internal" href="../installation.html"><em>Installation</em></a> to install the latest version of Tethys Apps. There are a few additional steps to Tethys Apps installation that are necessary (e.g.: setting up a database user for database provisioning).</p>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="view.html" class="btn btn-neutral float-right" title="The View and Templating">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="scaffold.html" class="btn btn-neutral" title="Generate New App with Scaffold"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Nathan Swain.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>